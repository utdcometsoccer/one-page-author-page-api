name: Build and deploy Azure Functions and Infrastructure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  # Function App paths
  FUNCTION_APP_PATH: 'function-app'
  IMAGE_API_PATH: 'ImageAPI'
  INK_STAINED_WRETCH_FUNCTIONS_PATH: 'InkStainedWretchFunctions'
  INK_STAINED_WRETCH_STRIPE_PATH: 'InkStainedWretchStripe'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v4

      - name: Setup DotNet ${{ env.DOTNET_VERSION }} Environment
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # =========================================
      # Build all Function Apps
      # =========================================

      - name: 'Build and Publish function-app'
        shell: bash
        run: |
          echo "Building function-app..."
          pushd '${{ env.FUNCTION_APP_PATH }}'
          dotnet build --configuration Release
          dotnet publish --configuration Release --output ./output
          popd

      - name: 'Zip function-app Output'
        shell: bash
        run: |
          cd '${{ env.FUNCTION_APP_PATH }}/output'
          zip -r ../functionapp.zip .
          cd ../..

      - name: 'Build and Publish ImageAPI'
        shell: bash
        run: |
          echo "Building ImageAPI..."
          pushd '${{ env.IMAGE_API_PATH }}'
          dotnet build --configuration Release
          dotnet publish --configuration Release --output ./output
          popd

      - name: 'Zip ImageAPI Output'
        shell: bash
        run: |
          cd '${{ env.IMAGE_API_PATH }}/output'
          zip -r ../imageapi.zip .
          cd ../..

      - name: 'Build and Publish InkStainedWretchFunctions'
        shell: bash
        run: |
          echo "Building InkStainedWretchFunctions..."
          pushd '${{ env.INK_STAINED_WRETCH_FUNCTIONS_PATH }}'
          dotnet build --configuration Release
          dotnet publish --configuration Release --output ./output
          popd

      - name: 'Zip InkStainedWretchFunctions Output'
        shell: bash
        run: |
          cd '${{ env.INK_STAINED_WRETCH_FUNCTIONS_PATH }}/output'
          zip -r ../inkstainedwretchfunctions.zip .
          cd ../..

      - name: 'Build and Publish InkStainedWretchStripe'
        shell: bash
        run: |
          echo "Building InkStainedWretchStripe..."
          pushd '${{ env.INK_STAINED_WRETCH_STRIPE_PATH }}'
          dotnet build --configuration Release
          dotnet publish --configuration Release --output ./output
          popd

      - name: 'Zip InkStainedWretchStripe Output'
        shell: bash
        run: |
          cd '${{ env.INK_STAINED_WRETCH_STRIPE_PATH }}/output'
          zip -r ../inkstainedwretchstripe.zip .
          cd ../..

      # =========================================
      # Azure Authentication
      # =========================================

      - name: 'Login to Azure'
        continue-on-error: true
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # =========================================
      # Deploy Cosmos DB Account (Conditional)
      # =========================================

      - name: 'Deploy Cosmos DB Account'
        continue-on-error: true
        shell: bash
        env:
          COSMOSDB_RESOURCE_GROUP: ${{ secrets.COSMOSDB_RESOURCE_GROUP }}
          COSMOSDB_ACCOUNT_NAME: ${{ secrets.COSMOSDB_ACCOUNT_NAME }}
          COSMOSDB_LOCATION: ${{ secrets.COSMOSDB_LOCATION }}
          COSMOSDB_ENABLE_FREE_TIER: ${{ secrets.COSMOSDB_ENABLE_FREE_TIER }}
          COSMOSDB_ENABLE_ZONE_REDUNDANCY: ${{ secrets.COSMOSDB_ENABLE_ZONE_REDUNDANCY }}
        run: |
          # Validate required secrets are available
          if [ -z "$COSMOSDB_RESOURCE_GROUP" ] || [ -z "$COSMOSDB_ACCOUNT_NAME" ] || [ -z "$COSMOSDB_LOCATION" ]; then
            echo "‚ö†Ô∏è Skipping Cosmos DB deployment: Required secrets not configured"
            echo "   Required: COSMOSDB_RESOURCE_GROUP, COSMOSDB_ACCOUNT_NAME, COSMOSDB_LOCATION"
            exit 0
          fi

          echo "‚úì Checking if Cosmos DB Account exists..."
          
          # Check if resource group exists, create if it doesn't
          if ! az group show --name "$COSMOSDB_RESOURCE_GROUP" &> /dev/null; then
            echo "üì¶ Creating resource group: $COSMOSDB_RESOURCE_GROUP"
            az group create --name "$COSMOSDB_RESOURCE_GROUP" --location "$COSMOSDB_LOCATION"
          else
            echo "‚úì Resource group exists: $COSMOSDB_RESOURCE_GROUP"
          fi

          # Check if Cosmos DB Account exists
          if ! az cosmosdb show --name "$COSMOSDB_ACCOUNT_NAME" --resource-group "$COSMOSDB_RESOURCE_GROUP" &> /dev/null; then
            echo "üì¶ Cosmos DB Account does not exist. Deploying..."
            
            # Build deployment parameters
            PARAMS="cosmosDbAccountName=$COSMOSDB_ACCOUNT_NAME location=$COSMOSDB_LOCATION"
            
            # Add optional free tier parameter if configured
            if [ "$COSMOSDB_ENABLE_FREE_TIER" = "true" ]; then
              PARAMS="$PARAMS enableFreeTier=true"
              echo "‚úì Free tier will be enabled"
            else
              PARAMS="$PARAMS enableFreeTier=false"
            fi
            
            # Add optional zone redundancy parameter if configured
            if [ "$COSMOSDB_ENABLE_ZONE_REDUNDANCY" = "true" ]; then
              PARAMS="$PARAMS enableZoneRedundancy=true"
              echo "‚úì Zone redundancy will be enabled"
            else
              PARAMS="$PARAMS enableZoneRedundancy=false"
              echo "‚ö†Ô∏è Zone redundancy disabled (recommended for development)"
            fi
            
            # Deploy Cosmos DB Account
            az deployment group create \
              --resource-group "$COSMOSDB_RESOURCE_GROUP" \
              --template-file infra/cosmosdb.bicep \
              --parameters $PARAMS \
              --output none
            
            echo "‚úì Cosmos DB Account deployed successfully"
            
            # Note: Connection string and keys are available in deployment outputs
            # but not displayed here for security reasons. They can be retrieved from
            # Azure Portal or using Azure CLI: az cosmosdb keys list
          else
            echo "‚úì Cosmos DB Account already exists. Skipping deployment."
          fi

      # =========================================
      # Deploy Application Insights (Conditional)
      # =========================================

      - name: 'Deploy Application Insights'
        continue-on-error: true
        shell: bash
        env:
          COSMOSDB_RESOURCE_GROUP: ${{ secrets.COSMOSDB_RESOURCE_GROUP }}
          APPINSIGHTS_NAME: ${{ secrets.APPINSIGHTS_NAME }}
          COSMOSDB_LOCATION: ${{ secrets.COSMOSDB_LOCATION }}
        run: |
          # Validate required secrets are available
          if [ -z "$COSMOSDB_RESOURCE_GROUP" ] || [ -z "$APPINSIGHTS_NAME" ] || [ -z "$COSMOSDB_LOCATION" ]; then
            echo "‚ö†Ô∏è Skipping Application Insights deployment: Required secrets not configured"
            echo "   Required: COSMOSDB_RESOURCE_GROUP, APPINSIGHTS_NAME, COSMOSDB_LOCATION"
            exit 0
          fi

          echo "‚úì Checking if Application Insights exists..."
          
          # Check if resource group exists (should exist from Cosmos DB step)
          if ! az group show --name "$COSMOSDB_RESOURCE_GROUP" &> /dev/null; then
            echo "üì¶ Creating resource group: $COSMOSDB_RESOURCE_GROUP"
            az group create --name "$COSMOSDB_RESOURCE_GROUP" --location "$COSMOSDB_LOCATION"
          else
            echo "‚úì Resource group exists: $COSMOSDB_RESOURCE_GROUP"
          fi

          # Check if Application Insights exists
          if ! az monitor app-insights component show --app "$APPINSIGHTS_NAME" --resource-group "$COSMOSDB_RESOURCE_GROUP" &> /dev/null; then
            echo "üì¶ Application Insights does not exist. Deploying..."
            
            # Deploy Application Insights
            az deployment group create \
              --resource-group "$COSMOSDB_RESOURCE_GROUP" \
              --template-file infra/applicationinsights.bicep \
              --parameters appInsightsName="$APPINSIGHTS_NAME" \
                          location="$COSMOSDB_LOCATION" \
              --output none
            
            echo "‚úì Application Insights deployed successfully"
            
            # Note: Instrumentation key and connection string are available in deployment outputs
            # but not displayed here for security reasons. They can be retrieved from
            # Azure Portal or using Azure CLI: az monitor app-insights component show
          else
            echo "‚úì Application Insights already exists. Skipping deployment."
          fi

      # =========================================
      # Deploy Existing function-app Infrastructure
      # =========================================

      - name: 'Deploy function-app Infrastructure'
        continue-on-error: true
        shell: bash
        env:
          FUNCTION_APP_NAME: ${{ secrets.AZURE_FUNCTIONAPP_NAME }}
          RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          LOCATION: ${{ secrets.AZURE_LOCATION }}
        run: |
          # Validate required secrets are available
          if [ -z "$FUNCTION_APP_NAME" ] || [ -z "$RESOURCE_GROUP" ] || [ -z "$LOCATION" ]; then
            echo "‚ö†Ô∏è Skipping function-app infrastructure deployment: Required secrets not configured"
            echo "   Required: AZURE_FUNCTIONAPP_NAME, AZURE_RESOURCE_GROUP, AZURE_LOCATION"
            exit 0
          fi

          echo "‚úì Checking if function-app exists..."
          # Check if Function App exists
          if ! az functionapp show --name "$FUNCTION_APP_NAME" --resource-group "$RESOURCE_GROUP" &> /dev/null; then
            echo "üì¶ Function App does not exist. Deploying infrastructure..."
            az deployment group create \
              --resource-group "$RESOURCE_GROUP" \
              --template-file infra/functionapp.bicep \
              --parameters functionAppName="$FUNCTION_APP_NAME" \
                          location="$LOCATION"
            echo "‚úì Infrastructure deployed successfully"
          else
            echo "‚úì Function App already exists. Skipping infrastructure deployment."
          fi

      - name: 'Deploy to function-app'
        continue-on-error: true
        shell: bash
        env:
          FUNCTION_APP_NAME: ${{ secrets.AZURE_FUNCTIONAPP_NAME }}
          RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
        run: |
          # Validate required secrets are available
          if [ -z "$FUNCTION_APP_NAME" ] || [ -z "$RESOURCE_GROUP" ]; then
            echo "‚ö†Ô∏è Skipping function-app deployment: Required secrets not configured"
            echo "   Required: AZURE_FUNCTIONAPP_NAME, AZURE_RESOURCE_GROUP"
            exit 0
          fi

          echo "üöÄ Deploying function-app..."
          az functionapp deployment source config-zip \
            --name "$FUNCTION_APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --src '${{ env.FUNCTION_APP_PATH }}/functionapp.zip'
          echo "‚úì function-app deployed successfully"

      # =========================================
      # Deploy Ink Stained Wretches Infrastructure
      # =========================================

      - name: 'Deploy Ink Stained Wretches Infrastructure'
        continue-on-error: true
        shell: bash
        env:
          ISW_RESOURCE_GROUP: ${{ secrets.ISW_RESOURCE_GROUP }}
          ISW_LOCATION: ${{ secrets.ISW_LOCATION }}
          ISW_BASE_NAME: ${{ secrets.ISW_BASE_NAME }}
          ISW_DNS_ZONE_NAME: ${{ secrets.ISW_DNS_ZONE_NAME }}
          COSMOSDB_CONNECTION_STRING: ${{ secrets.COSMOSDB_CONNECTION_STRING }}
          STRIPE_API_KEY: ${{ secrets.STRIPE_API_KEY }}
          AAD_TENANT_ID: ${{ secrets.AAD_TENANT_ID }}
          AAD_AUDIENCE: ${{ secrets.AAD_AUDIENCE }}
        run: |
          # Validate required secrets are available
          if [ -z "$ISW_RESOURCE_GROUP" ] || [ -z "$ISW_LOCATION" ] || [ -z "$ISW_BASE_NAME" ]; then
            echo "‚ö†Ô∏è Skipping Ink Stained Wretches infrastructure deployment: Required secrets not configured"
            echo "   Required: ISW_RESOURCE_GROUP, ISW_LOCATION, ISW_BASE_NAME"
            exit 0
          fi

          echo "üì¶ Deploying Ink Stained Wretches Infrastructure..."

          # Check if resource group exists, create if it doesn't
          if ! az group show --name "$ISW_RESOURCE_GROUP" &> /dev/null; then
            echo "Creating resource group: $ISW_RESOURCE_GROUP"
            az group create --name "$ISW_RESOURCE_GROUP" --location "$ISW_LOCATION"
          else
            echo "‚úì Resource group exists: $ISW_RESOURCE_GROUP"
          fi

          # Build deployment parameters
          PARAMS="baseName=$ISW_BASE_NAME location=$ISW_LOCATION"

          # Add optional parameters if configured
          if [ -n "$ISW_DNS_ZONE_NAME" ]; then
            PARAMS="$PARAMS deployDnsZone=true dnsZoneName=$ISW_DNS_ZONE_NAME"
            echo "‚úì DNS Zone will be deployed: $ISW_DNS_ZONE_NAME"
          else
            PARAMS="$PARAMS deployDnsZone=false"
            echo "‚ö†Ô∏è DNS Zone deployment skipped (ISW_DNS_ZONE_NAME not set)"
          fi

          # Deploy infrastructure
          echo "üöÄ Starting infrastructure deployment..."
          az deployment group create \
            --resource-group "$ISW_RESOURCE_GROUP" \
            --template-file infra/inkstainedwretches.bicep \
            --parameters $PARAMS \
                        cosmosDbConnectionString="$COSMOSDB_CONNECTION_STRING" \
                        stripeApiKey="$STRIPE_API_KEY" \
                        aadTenantId="$AAD_TENANT_ID" \
                        aadAudience="$AAD_AUDIENCE" \
            --output json > deployment-output.json

          echo "‚úì Infrastructure deployment completed"

          # Extract and display outputs
          echo "üìã Deployment outputs:"
          cat deployment-output.json | jq '.properties.outputs'

      # =========================================
      # Deploy ImageAPI Function App
      # =========================================

      - name: 'Deploy ImageAPI Function App'
        continue-on-error: true
        shell: bash
        env:
          ISW_RESOURCE_GROUP: ${{ secrets.ISW_RESOURCE_GROUP }}
          ISW_BASE_NAME: ${{ secrets.ISW_BASE_NAME }}
          DEPLOY_IMAGE_API: ${{ secrets.DEPLOY_IMAGE_API }}
        run: |
          # Skip if ImageAPI deployment is not enabled
          if [ "$DEPLOY_IMAGE_API" != "true" ] || [ -z "$ISW_RESOURCE_GROUP" ] || [ -z "$ISW_BASE_NAME" ]; then
            echo "‚ö†Ô∏è Skipping ImageAPI deployment"
            echo "   DEPLOY_IMAGE_API=$DEPLOY_IMAGE_API"
            echo "   ISW_RESOURCE_GROUP=$ISW_RESOURCE_GROUP"
            echo "   ISW_BASE_NAME=$ISW_BASE_NAME"
            exit 0
          fi

          FUNCTION_APP_NAME="${ISW_BASE_NAME}-imageapi"
          echo "üöÄ Deploying ImageAPI to: $FUNCTION_APP_NAME"

          az functionapp deployment source config-zip \
            --name "$FUNCTION_APP_NAME" \
            --resource-group "$ISW_RESOURCE_GROUP" \
            --src '${{ env.IMAGE_API_PATH }}/imageapi.zip'

          echo "‚úì ImageAPI deployed successfully"

      # =========================================
      # Deploy InkStainedWretchFunctions Function App
      # =========================================

      - name: 'Deploy InkStainedWretchFunctions Function App'
        continue-on-error: true
        shell: bash
        env:
          ISW_RESOURCE_GROUP: ${{ secrets.ISW_RESOURCE_GROUP }}
          ISW_BASE_NAME: ${{ secrets.ISW_BASE_NAME }}
          DEPLOY_ISW_FUNCTIONS: ${{ secrets.DEPLOY_ISW_FUNCTIONS }}
        run: |
          # Skip if InkStainedWretchFunctions deployment is not enabled
          if [ "$DEPLOY_ISW_FUNCTIONS" != "true" ] || [ -z "$ISW_RESOURCE_GROUP" ] || [ -z "$ISW_BASE_NAME" ]; then
            echo "‚ö†Ô∏è Skipping InkStainedWretchFunctions deployment"
            echo "   DEPLOY_ISW_FUNCTIONS=$DEPLOY_ISW_FUNCTIONS"
            echo "   ISW_RESOURCE_GROUP=$ISW_RESOURCE_GROUP"
            echo "   ISW_BASE_NAME=$ISW_BASE_NAME"
            exit 0
          fi

          FUNCTION_APP_NAME="${ISW_BASE_NAME}-functions"
          echo "üöÄ Deploying InkStainedWretchFunctions to: $FUNCTION_APP_NAME"

          az functionapp deployment source config-zip \
            --name "$FUNCTION_APP_NAME" \
            --resource-group "$ISW_RESOURCE_GROUP" \
            --src '${{ env.INK_STAINED_WRETCH_FUNCTIONS_PATH }}/inkstainedwretchfunctions.zip'

          echo "‚úì InkStainedWretchFunctions deployed successfully"

      # =========================================
      # Deploy InkStainedWretchStripe Function App
      # =========================================

      - name: 'Deploy InkStainedWretchStripe Function App'
        continue-on-error: true
        shell: bash
        env:
          ISW_RESOURCE_GROUP: ${{ secrets.ISW_RESOURCE_GROUP }}
          ISW_BASE_NAME: ${{ secrets.ISW_BASE_NAME }}
          DEPLOY_ISW_STRIPE: ${{ secrets.DEPLOY_ISW_STRIPE }}
        run: |
          # Skip if InkStainedWretchStripe deployment is not enabled
          if [ "$DEPLOY_ISW_STRIPE" != "true" ] || [ -z "$ISW_RESOURCE_GROUP" ] || [ -z "$ISW_BASE_NAME" ]; then
            echo "‚ö†Ô∏è Skipping InkStainedWretchStripe deployment"
            echo "   DEPLOY_ISW_STRIPE=$DEPLOY_ISW_STRIPE"
            echo "   ISW_RESOURCE_GROUP=$ISW_RESOURCE_GROUP"
            echo "   ISW_BASE_NAME=$ISW_BASE_NAME"
            exit 0
          fi

          FUNCTION_APP_NAME="${ISW_BASE_NAME}-stripe"
          echo "üöÄ Deploying InkStainedWretchStripe to: $FUNCTION_APP_NAME"

          az functionapp deployment source config-zip \
            --name "$FUNCTION_APP_NAME" \
            --resource-group "$ISW_RESOURCE_GROUP" \
            --src '${{ env.INK_STAINED_WRETCH_STRIPE_PATH }}/inkstainedwretchstripe.zip'

          echo "‚úì InkStainedWretchStripe deployed successfully"
